<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Image Cropping Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.2/croppie.css'>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.2/croppie.js'></script>

  <link href="assets/css/base.css" rel="stylesheet">
 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    #my-image {
      max-width: 100%;
      max-height: 300px;
      margin-bottom: 20px;
      display:none;
    }
    .icon-plus {
      font-size: 24px;
      color: #bbb;
    }

    .grid-add {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            width: 100%;
            margin: 20px auto;
          }
          .grid-add-item {
            background-color: #eee;
            padding: 20px;
            text-align: center;
            height: 240px;
            border-radius: 7px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border:2px dashed #ddd;
            cursor: pointer;
            .icon-plus{
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="%235f6368"><path d="M323-172.38v-396.24q0-28.08 19.42-48.23T391.38-637h396.24q28.44 0 48.41 19.97Q856-597.06 856-568.62v283.7L675.08-104h-283.7q-28.44 0-48.41-19.97Q323-143.94 323-172.38ZM106-706.46q-5.23-27.69 11.27-51.46 16.5-23.76 43.88-27.93l390-68.92q27.7-4.23 51.41 12.16 23.71 16.38 27.98 43.76l13.38 75.7h-43.66l-12.8-71.93q-1.54-8.46-9.23-13.46T561.31-812l-392.54 68.46q-10 1.54-15.77 10.39-5.77 8.84-4.23 18.84l88.08 497.85v-43.16q-23.39-.76-40.54-16.23-17.16-15.46-21.98-40.48L106-706.46Zm260.77 137.84v396.24q0 10.76 6.92 17.69 6.93 6.92 17.69 6.92h259l161.85-161.85v-259q0-10.76-6.92-17.69-6.93-6.92-17.69-6.92H391.38q-10.76 0-17.69 6.92-6.92 6.93-6.92 17.69ZM590-371Zm-22.38 129.38h43.76v-107h107v-43.76h-107v-107h-43.76v107h-107v43.76h107v107Z"/></svg>');
                background-size:cover;
                background-repeat: no-repeat;
                width: 60px;
                height: 60px;
                opacity: .2;
            }
            
          }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col">
        <form id="form1" runat="server">
          <input type='file' id="imgInp" style="display: none;" />
          <img id="my-image" src="#" />
        </form>
        <button id="use" class="btn btn-primary" style="display: none;">Upload</button>
        <img id="result" src="" style="display: none;">
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col">
      <div class="grid-add">
        <div class="grid-add-item"><div class="icon-plus"></div></div>
        <div class="grid-add-item"><div class="icon-plus"></div></div>
        <div class="grid-add-item"><div class="icon-plus"></div></div>
        <div class="grid-add-item"><div class="icon-plus"></div></div>
      </div>
      </div>
  </div>

  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Set the position of your image</h5>
        </div>
        <div class="modal-body">
          <div id="croppie-container"></div>
        </div>
        <div class="modal-footer">
          <button id="saveCrop" class="btn btn-primary">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      var resize;
      var currentGridItem;

      $('.grid-add-item').on('click', function () {
        currentGridItem = $(this); // Save the current grid item
        $('#imgInp').click(); // Trigger the file input
      });

      $('#imgInp').on('change', function () {
        var input = this;
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            $('#my-image').attr('src', e.target.result);
            $('#imageModal').modal('show'); // Show the modal first
            initializeCroppie(); // Initialize Croppie after modal is shown
          };
          reader.readAsDataURL(input.files[0]);
        }
      });

      // Function to initialize Croppie
      function initializeCroppie() {
        if (!resize) {
          resize = new Croppie(document.getElementById('croppie-container'), {
            viewport: {
              width: 200,
              height: 240,
              type: 'square'
            },
            boundary: {
              width: 300,
              height: 300
            },
          });
        } else {
          // If Croppie instance already exists, re-bind to update dimensions
          resize.bind({
            url: $('#my-image').attr('src')
          });
        }
      }

      // Save button click event
      $('#saveCrop').on('click', function () {
        resize.result({
          type: 'base64',
          size: 'viewport'
        }).then(function (dataImg) {
          var originalBase64 = $('#my-image').attr('src');
          console.log(originalBase64); // imagem original
          console.log(dataImg); // imagem cortada
          currentGridItem.css('background-image', 'url(' + dataImg + ')');
          currentGridItem.find('.icon-plus').hide(); // Hide the icon-plus element
          $('#imageModal').modal('hide');
        });
      });

      // Prevent modal close on backdrop click
      $('#imageModal').modal({
        backdrop: 'static',
        keyboard: false
      });

      // Re-bind Croppie on modal show
      $('#imageModal').on('shown.bs.modal', function () {
        initializeCroppie();
      });
    });
  </script>
</body>
</html>
