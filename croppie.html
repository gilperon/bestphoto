<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Image Cropping Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.2/croppie.css'>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.2/croppie.js'></script>

  <link href="assets/css/base.css" rel="stylesheet">
 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .row {
      height: 100vh;
    }

    #my-image {
      max-width: 100%;
      max-height: 300px;
      margin-bottom: 20px;
    }

    .modal-dialog {
      /* max-width: 80%; */
      /* margin: 1.75rem auto; */
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col">
        <form id="form1" runat="server">
          <input type='file' id="imgInp" />
          <img id="my-image" src="#" />
        </form>
        <button id="use" class="btn btn-primary">Upload</button>
        <img id="result" src="" style="display: none;">
      </div>
    </div>
  </div>

 <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Crop Image</h5>
      </div>
      <div class="modal-body">
        <div id="croppie-container"></div>
      </div>
      <div class="modal-footer">
        <button id="saveCrop" class="btn btn-primary">Salvar</button>
      </div>
    </div>
  </div>
</div>

  <script>
    $(document).ready(function () {
      var resize;

      $('#imgInp').on('change', function () {
        var input = this;
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            $('#my-image').attr('src', e.target.result);
            $('#imageModal').modal('show'); // Show the modal first
            initializeCroppie(); // Initialize Croppie after modal is shown
          };
          reader.readAsDataURL(input.files[0]);
        }
      });

      // Function to initialize Croppie
      function initializeCroppie() {
        if (!resize) {
          resize = new Croppie(document.getElementById('croppie-container'), {
            viewport: {
              width: 200,
              height: 240,
              type: 'square'
            },
            boundary: {
              width: 300,
              height: 300
            },
          });

        } else {
          // If Croppie instance already exists, re-bind to update dimensions
          resize.bind({
            url: $('#my-image').attr('src')
          });
        }
      }

      // Save button click event
      $('#saveCrop').on('click', function () {
        resize.result({
          type: 'base64',
          size: 'viewport'
        }).then(function (dataImg) {
          $('#result').attr('src', dataImg).css('display', 'block');
          $('#imageModal').modal('hide');
        });
      });

      // Prevent modal close on backdrop click
      $('#imageModal').modal({
        backdrop: 'static',
        keyboard: false
      });

      // Re-bind Croppie on modal show
      $('#imageModal').on('shown.bs.modal', function () {
        initializeCroppie();
      });
    });
  </script>
</body>

</html>
